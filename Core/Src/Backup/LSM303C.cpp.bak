//
// Created by Mateusz Wojtaszek on 15/03/2025.
//
#include "LSM303C.h"

#include <spi.h>
#include <stm32l4xx_hal_gpio.h>

void gyro_write(uint8_t reg, uint8_t data) {
  uint8_t tx[2] = {reg & 0x7F, data};
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_RESET);
  HAL_SPI_Transmit(&hspi2, tx, 2, 1000);
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_SET);
}

void gyro_init(void) {
  gyro_write(CTRL_REG1, CTRL_REG1_DATA);
  gyro_write(CTRL_REG2, CTRL_REG2_DATA);
  gyro_write(CTRL_REG3, CTRL_REG3_DATA);
  gyro_write(CTRL_REG4, CTRL_REG4_DATA);
  gyro_write(CTRL_REG5, CTRL_REG5_DATA);
}

uint8_t gyro_read(uint8_t reg) {
  uint8_t tx = reg | 0x80;
  uint8_t rx = 0;
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_SET);
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_RESET);
  HAL_SPI_Transmit(&hspi2, &tx, 1, 1000);
  HAL_SPI_Receive(&hspi2, &rx, 1, 1000);
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_SET);
  return rx;
}


void gyro_read_data(GyroFullProcessedData *gyro_full_data) {
  const uint8_t tx = OUT_X_L | 0xC0;
  uint8_t rx[6];
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_SET);
  HAL_GPIO_WritePin(GYRO_CS_GPIO_Port, GYRO_CS_Pin, GPIO_PIN_RESET);
  HAL_SPI_Transmit(&hspi2, &tx, 1, 1000);
  HAL_SPI_Receive(&hspi2, rx, 6, 1000);
  uint8_t temp = gyro_read(OUT_TEMP);
  gyro_full_data->x_dps = ((float)((int16_t)(rx[1] << 8) | rx[0])/17.5f) - bias_x;
  gyro_full_data->y_dps = ((float)((int16_t)(rx[3] << 8) | rx[2])/17.5f) - bias_y;
  gyro_full_data->z_dps = ((float)((int16_t)(rx[5] << 8) | rx[4])/17.5f) - bias_z;
  gyro_full_data->temperature_c = (int8_t)temp;
}

